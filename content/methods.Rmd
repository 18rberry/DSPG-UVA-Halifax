---
title: "Data & Methods"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 15, fig.height = 10)

library(dplyr)
library(leaflet)
library(leaflet.mapboxgl)
library(tidycensus)
library(tigris)
library(tidyr)
library(here)
library(sf)

token <- Sys.getenv("MAPBOX_TOKEN")
options(mapbox.accessToken = token)
```

```{r}
create_map <- function(.data, # spatial dataset to use
                       variables, # character vector of names to be used, does not include _estimate or _moe at end. Example: estimate_percent_below_poverty_level_population_for_whom_poverty_status_is_determined
                       group_names, # The names to appear on the radio button widget, determing which variable to display
                       legend_name, # name of the legend
                       label_name, # What precedes the variable value on the hoverover label
                       scale_domain, # over what values is the scale defined? Values outside will be color NA
                       scale_breaks, # what divides the colors of the scale? For a 4 color scale, and example would be c(0, 25, 50, 75, 100) Note endpoints are included
                       unstable_threshold # How many times larger does the estimate have to be than the margin of error to be considered non-null?
) {
  color_scale <- colorBin("BuPu", scale_domain, scale_breaks)
  
  check_unstable <- function(variable) {
    ifelse((.data[[glue("{variable}_estimate")]]) < unstable_threshold * .data[[glue("{variable}_moe")]],
           NA,
           .data[[glue("{variable}_estimate")]])
  }
  
  add_poly_layer <- function(map, variable, group_name, color_scale) {
    addPolygons(map, color = "#444444", weight = 0.5, smoothFactor = 0.5,
                opacity = 1.0, fillOpacity = 0.8,
                fillColor = color_scale(check_unstable(variable)),
                group = group_name,
                label = ~purrr::map(glue("{NAME.x} County<br/>
                                  {label_name}: {.data[[paste0(variable, \"_estimate\")]]}<br/>
                                  MOE: {.data[[paste0(variable, \"_moe\")]]}"), htmltools::HTML))
  }
  
  map <- leaflet(.data) %>%
    addMapboxGL(style = "mapbox://styles/mapbox/light-v9")
  
  for (i in 1:length(variables)) {
    map <- map %>%
      add_poly_layer(variable = variables[i], group_name = group_names[i], color_scale = color_scale)
  }
  
  map <- map %>%
    addLegend("bottomright", pal = color_scale, values = .data[[glue("{variables[1]}_estimate")]],
              title = legend_name,
              opacity = .9
    )
  
  if(!is.null(group_names)) {
    map <- map %>%
      addLayersControl(
        baseGroups = group_names,
        options = layersControlOptions(collapsed = FALSE)
      )
  }
  
  map
}
```

```{css, echo=FALSE}
/* this chunk of code centers all of the headings */
  h1, h2, h3 {
    text-align: center;
  }

body {
  text-align: justify
}
```

## Background

Halifax County is a large, predominantly rural county in Southside Virginia. Its largest town, South Boston, recorded a population just shy of 8,000 during the decennial census, and the county as a whole has seen a recent decline in population from around 36,000 to 34,000 people in the past decade. (CITE CENSUS).

```{r}

age_sex_race_county <- st_read(here::here("data", "original", "ACS", "acs_age_sex_race_county.geojson"))

BAMMtools::getJenksBreaks(age_sex_race_county$percent_estimate_race_total_population_one_race_black_or_african_american_estimate, 6)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(0, 10, 22, 35, 50, 75))

leaflet(width = "100%") %>%
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  addPolygons(data = age_sex_race_county,
              fillColor = ~pal(percent_estimate_race_total_population_one_race_black_or_african_american_estimate),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 1)

create_map(age_sex_race_county, c("percent_estimate_race_total_population_one_race_black_or_african_american", "percent_estimate_race_total_population_one_race_white"),
           group_names = c("Black" ,"White"),
           legend_name = "Percentage Selected Race",
           label_name = "Percentage",
           scale_domain = c(0, 1),
           scale_breaks = c(0, 10, 25, 40, 60, 75, 90, 100),
           unstable_threshold = 1.5)


```

```{r}
BAMMtools::getJenksBreaks(age_sex_race_county$estimate_sex_and_age_total_population_median_age_.years._estimate, 7)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(20, 28, 36, 41, 45, 50, 60))

leaflet(width = "100%") %>%
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  addPolygons(data = age_sex_race_county,
              fillColor = ~pal(estimate_sex_and_age_total_population_median_age_.years._estimate),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 1)
```

```{r}

acs_median_income_county <- st_read(here::here("data", "original", "ACS", "acs_median_income_county.geojson"))

BAMMtools::getJenksBreaks(acs_median_income_county$estimate_median_income_.dollars._household_income_by_race_and_hispanic_or_latino_origin_of_householder_households_one_race.._black_or_african_american_estimate, 6)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(10000, 35000, 50000, 65000, 100000, 150000))

create_map(acs_median_income_county,
           c("estimate_median_income_.dollars._household_income_by_race_and_hispanic_or_latino_origin_of_householder_households_one_race.._black_or_african_american","estimate_median_income_.dollars._household_income_by_race_and_hispanic_or_latino_origin_of_householder_households_one_race.._white"),
           group_names = c("Black Median Income", "White Median Income"),
           legend_name = "Median Income",
           label_name = "Median income",
           scale_domain = c(10000, 150000),
           scale_breaks = c(10000, 35000, 50000, 65000, 100000, 150000),
           unstable_threshold = 1.5)
```

```{r}
halifax_decennial_data <- st_read(here::here("src", "Data_Ingestion", "halifax_decennial_data.geojson"))

BAMMtools::getJenksBreaks(halifax_decennial_data$pct_black_race, 4)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(0.15, 0.25, 0.4, 0.5, 1))

halifax_decennial_data %>%
  #limited dragging and set minimum and maximum zoom settings
leaflet(width = "100%") %>%
  #added base tiles
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  #added layers of chloropleth maps depicting each race
  addPolygons(fillColor = ~pal(pct_black_race),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5) %>%
  addLegend(position = "bottomright", pal = pal, values = c(0,1), 
            title = "Proportion Black")

```

```{r}
BAMMtools::getJenksBreaks(halifax_decennial_data$total_median_age, 4)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(38, 42, 46, 50))

halifax_decennial_data %>%
  #limited dragging and set minimum and maximum zoom settings
leaflet(width = "100%") %>%
  #added base tiles
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  #added layers of chloropleth maps depicting each race
  addPolygons(fillColor = ~pal(total_median_age),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5,
              label = ~total_median_age) %>%
  addLegend(position = "bottomright", pal = pal, values = c(0,1), 
            title = "Proportion Black")
```

```{r}
BAMMtools::getJenksBreaks(halifax_decennial_data$pct_female_no_husband_household, 4)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(0, 0.1, 0.15, 0.25, 1))

halifax_decennial_data %>%
  #limited dragging and set minimum and maximum zoom settings
leaflet(width = "100%") %>%
  #added base tiles
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  #added layers of chloropleth maps depicting each race
  addPolygons(fillColor = ~pal(pct_female_no_husband_household),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5) %>%
  addLegend(position = "bottomright", pal = pal, values = c(0,1), 
            title = "Proportion Single Women Households")
```

```{r}
housing_data <- halifax_decennial_data %>%
  mutate(pct_white_owner = white_owner/ (total_owner + total_renter)) %>%
  mutate(pct_black_owner = black_owner/(total_owner + total_renter)) %>%
  mutate(pct_white_renter = white_renter/(total_owner + total_renter)) %>%
  mutate(pct_black_renter = black_renter/(total_owner + total_renter))

BAMMtools::getJenksBreaks(halifax_decennial_data$pct_white_renter, 4)
pal <- colorBin("BuPu", domain = c(0, 1), bins = c(0, 0.15, 0.3, 0.45, 0.6, 1))

  #limited dragging and set minimum and maximum zoom settings
leaflet(housing_data, width = "100%") %>%
  #added base tiles
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  #added layers of chloropleth maps depicting each race
  addPolygons(fillColor = ~pal(pct_black_renter),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5,
              group = "Black Renters") %>%
    addPolygons(fillColor = ~pal(pct_white_renter),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5,
              group = "White Renters") %>%
    addPolygons(fillColor = ~pal(pct_black_owner),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5,
              group = "Black Owners") %>%
    addPolygons(fillColor = ~pal(pct_white_owner),
              fillOpacity = 0.8,
              color = "#444444",
              weight = 0.5,
              group = "White Owners") %>%
  addLayersControl(baseGroups = c("Black Renters", "White Renters", "Black Owners", "White Owners")) %>%
  addLegend(position = "bottomright", pal = pal, values = c(0,1), 
            title = "Proportion Black")
```

## Data Sources

As is the case with any new project, significant time must be devoted to identifying data sources and assessing their quality, accessibility, and relevance to the topics at hand. 

The first avenue we considered was the Virginia Department of Corrections, which maintains data on inmates in Virginia jails and prisons. Unfortunately, it quickly became apparent that the process of obtaining access to these data would likely be drawn out both because of the care required when transferring sensitive data on a vulnerable population as well as other general bureaucratic hurdles involved in obtaining approval. The focus of criminal justice institutions on reacing to the COVID-19 pandemic also may have played a role in our inability to obtain these data within the summer timeframe for this project.

Realizing that this source was likely out of reach, we also considered court records data from the state of Virginia. However, while these data are publicly-available, they are only accessible via a user-facing search tool, whereas a more comprehensive analysis would require access to the underlying database. We initiated a request for these data, and while this has seen recent progress, it also became apparent that this source would be outside the scope for the summer portion of this project.

Given these struggles, we decided to shift our approach to instead focus more directly on the social determinants of incarceration, which we hoped would also be of relevance to Halifax County given the role of the proposed Family and Consumer Science Agent. Guided by the ecological model and an extensive literature review, we identified four primary social factors to explore: unemployment, substance abuse, affordable housing, and family structure/foster care.

We encountered similar challenges as we considered various data sources on each of these topics, but ultimately arrived at a subset that could be incorporated into our exploration of these factors in Halifax. A summary of the final data sources used for each factor (as well as other relevant topics) are below:

```{r}
sources <- readr::read_csv(here::here("data", "working", "data_sources_final.csv")) %>%
  dplyr::select(-X4)

knitr::kable(sources, "html", caption = "Final Summary of Data Sources") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "bordered"), full_width = FALSE)
```

## Challenges

In addition to the data access issues mentioned above, we encountered other difficulties as we assembled a collection of sources for our specific social factors as well.

#### Lack of relevance to formerly incarcerated population.

Many of the most comprehensive data sources on these issues do not specifically address incarcerated or formerly incarcerated individuals, and it is questionable whether the patterns observed in these sources generalize to this population. For instance, Housing and Urban Development's Picture of Subsidized Households dataset provides information on characteristics of individuals in subsidized housing, but no data is recorded on the use of these services by formerly-incarcerated individuals themselves. 

#### Spatial resolution

Many potential datasets measured variables that may have been valuable to include, but only measured them at the national or state level (this was particularly true for substance abuse). While these sources may have been helpful for context, their applicability to Halifax specifically was suspect.

Furthermore, the data that did exist at the sub-county level suffered from low sample sizes and associated high uncertainty, making it difficult to draw definitive conclusions about the population for particular regions in Halifax.

As an example, consider the following map, which was constructed by using American Community Survey data for     geographic mobility at the census tract level in Halifax. Each layer of the map represents a different sampled value based on the variability of the estimates reported by the ACS. It's easy to see that many tracts have significantly different reported mobility values depending on the random sample taken. This serves to highlight the potential issues relying on ACS estimates at the tract level for rural counties like Halifax. 

```{r results = "hide"}
source(here("src", "Mapping", "map_template.R"))

## Variable names for ACS
## Variable names for ACS
# vars_2018 <- load_variables(2018, dataset = "acs5", cache = TRUE)
# profile_vars_2018 <- load_variables(2018, dataset = "acs5/profile", cache = TRUE)
subject_vars_2018 <- invisible(load_variables(2018, dataset = "acs5/subject", cache = TRUE))

## Polygons for counties and tracts
va_counties <- counties(state = "VA", class = "sf", cb = TRUE, resolution = "20m") %>%
  st_transform(crs = 4326)

halifax_tracts <- tracts(state = "VA", county = "Halifax", class = "sf", cb = TRUE) %>%
  st_transform(crs = 4326)

## ACS table IDs
# tables <- c("B07013", ## Geographic mobility
#             "S2507", ## Financial characteristics - no mortgage
#             "S2504", ## Physical characteristics
#             "S2502", ## Demographic characteristics
#             "DP04") ## General housing statistics

# ----- Geographic mobility ---- #

## County level geographic mobility variables
# geog_mobility <- get_acs(geography = "county",
#                          year = 2018,
#                          table = "S0701",
#                          state = "VA") %>%
#   left_join(subject_vars_2018, by = c("variable" = "name")) %>%
#   mutate(label = tolower(gsub(";", "", gsub(",", "", gsub(" ", "_", gsub("!!", "_", label)))))) %>%
#   select(-variable) %>%
#   pivot_wider(names_from = label,
#               values_from = c(estimate, moe),
#               names_glue = "{label}_{.value}")

## Tract level geographic mobility variables
geog_mobility_tracts <- get_acs(geography = "tract",
                                year = 2018,
                                table = "S0701",
                                state = "VA",
                                county = "Halifax") %>%
  left_join(subject_vars_2018, by = c("variable" = "name")) %>%
  mutate(label = tolower(gsub(";", "", gsub(",", "", gsub(" ", "_", gsub("!!", "_", label))))))%>%
  select(-variable) %>%
  pivot_wider(names_from = label,
              values_from = c(estimate, moe),
              names_glue = "{label}_{.value}")

## Merge ACS on spatial data
#geog_mobility_counties <- left_join(va_counties, geog_mobility, by = c("GEOID"))
geog_mobility_tracts <- left_join(halifax_tracts, geog_mobility_tracts, by = c("GEOID"))

## Sample from independent normals at tract level and plot across layers to show uncertainty in estimates
pal <- colorBin("BuPu", c(geog_mobility_tracts$estimate_moved_within_same_county_population_1_year_and_over_estimate - geog_mobility_tracts$estimate_moved_within_same_county_population_1_year_and_over_moe, geog_mobility_tracts$estimate_moved_within_same_county_population_1_year_and_over_estimate + geog_mobility_tracts$estimate_moved_within_same_county_population_1_year_and_over_moe), bins = 10, na.color = "gray")
```

```{r, fig.height=5}
set.seed(4351)

map_samples(data = geog_mobility_tracts,
            var = "estimate_moved_within_same_county_population_1_year_and_over_estimate",
            se_var = "estimate_moved_within_same_county_population_1_year_and_over_moe",
            x = 10,
            moe = TRUE,
            palette = pal,
            legend_pos = "bottomleft",
            legend_title = "Estimated number of people <br>that moved within county") %>%
  setView(lng = -79.1, lat = 36.8, zoom = 9)
```

#### Incarceration, or Crime?

After exhausting the most relevant data sources to incarceration and recidivism specifically, we were left with large-scale trends from the Vera Institute for Justice and crime records reported by the Virginia State Police. However, we hestitated to rely too heavily on the Virginia crime records for multiple reasons. 

Crime is not typically considered an optimal way to explore incarceration because crime records tend to strongly reflect systemic biases that exist both in the criminal justice system and in policing practices, and make no indication of whether an individual ends up actually being convicted and sentenced or not. Because of the strong underlying biases, we wanted to be sure not to over-interpret the data we did have.

## Summary

_Need some way to wrap this page up_






