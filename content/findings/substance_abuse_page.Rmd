---
title: "Substance Abuse"
description: "How does Halifax compare to surrounding areas on opioid and alcohol use?"
tags: ["R", "networks"]
weight: 5
draft: false
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 15, fig.height = 10)
#may not need 
#add packages here
options(knitr.duplicate.label = "allow")

```
### Background 
In many states and communities, substance abuse related felonies make up a large amount of convictions. As stated by a publication from Georgetown’s Journal on Poverty Law and Policy, ¾ state prisoners and ⅘ federal prisoners are alcohol/drug involved offenders. Additionally, 58% of state prisoners and 63% of sentenced jail inmates met the criteria for drug dependence or abuse, compared to 5% of the total adult population. There are also high rates of drug related crime; 17% of state prisoners and 18% of federal inmates committed their offense to obtain money to purchase drugs.

Successful substance abuse treatment has been shown to decrease rates of recidivism. However, many inmates do not receive effective treatment and thus experience higher likelihood of recidivism as well as more difficulty integrating into society when released. Unfortunately, 95% of offenders return to drug abuse and 60-80% commit a new drug-related crime upon being released from prison. 

Substance abuse intersects with incarceration at recidivism at various levels of the ecological model. Though stable housing is critical for recovery from SUDS, on an individual level, many people struggle to find places to live and become homeless. Individuals with former SUD-related convictions may also struggle with mental health issues and use substances to self-medicate, which may aggravate symptoms and lead to an addiction disorder. On the employment level, various federal employment guidelines as well as corporate stigma against substance-usage lead to people with substance abuse convictions losing their jobs or having difficulty getting hired. On the policy level, systematic racism in the law enforcement and criminal justice system leads to vast racial disparities in substance related arrests, convictions, and felonies. 

### Main Findings 

The raging opioid epidemic has hit states like Virginia, especially its rural communities such as Halifax county, the hardest. However, data from the Center for Disease Control on opioid usage in Virginia counties -- specifically, the opioid prescription rate per 100 people, proposes a positive perspective on how Halifax has handled the opioid epidemic. The line graph illustrates that while prescription rates peaked in 2010, they have been steadily decreasing since. In fact, Halifax seems to fare better than Virginia as a whole; opioid prescription rates have also gone down, but at a lesser rate and have peaked more frequently in 2012 and 2015. 

A map of the same data provides further context of Halifax’s opioid prescription rates compared to other Virginia counties, as well as the change in prescription rates over time for Virginia. The scale goes from 0 to 584 opioid prescription rates per 100 people, suggesting that in several counties, the majority of people have at least one prescription. Halifax is consistently in the second lowest bucket of prescription rates: 60 to 122. The spikes in Virginia rates are also evident through these maps. 

```{r}
library(ggplot2)
library(rvest)
library(sf)
library(tigris)
library(leaflet)
library(tidycensus)
library(stringr)
library(dplyr)
library(here)
library(BAMMtools)
library(tidyr)
library(leaflet.mapboxgl)

#set the theme 
theme_set(theme_minimal() +
            theme(plot.title = element_text(hjust = 0.5, color = "gray10", size = 24),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", face = "italic", size = 20),
                  axis.title = element_text(size = 20, color = "gray10"),
                  axis.text = element_text(size = 18, color = "gray30"),
                  strip.text = element_text(size = 22, color = "gray30"),
                  panel.spacing = unit(4, "lines"),
                  legend.key.size = unit(3, "line"),
                  legend.text = element_text(size = 16, color = "gray30"),
                  legend.title = element_text(size = 22, color = "gray10")))

options(mapbox.accessToken = Sys.getenv("MAPBOX_TOKEN"))

cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```


```{r}
#read CSV
datasource <- readr::read_csv(here::here("data",
                                         "original", "Substance_Abuse",
                                         "CDC Opioid Prescription Data - Halifax (1).csv")) %>%
  pivot_longer(cols = c(Halifax, `US Total`))

# total <- datasource$`US Total`

#plot the data
ggplot(data = datasource, aes(x = Year, y = value, color = name)) +
  #plot of Halifax and VA state over time
  geom_line(lwd = 1.1) +
  geom_point(size = 2) +
  labs(y = 'Opioid Prescription Rates per 100 People') +
  #relabel the scale appropriately
  scale_color_manual(name = "Location", labels = c("Halifax, VA", "US"), values = cbbPalette) +
  scale_x_continuous(labels = seq(2006, 2018), breaks = seq(2006, 2018)) +
  theme(panel.grid.minor = element_blank())
```
```{r, results = "hide"}
#load VA border geographical data
va_borders <- get_acs(table = "B01003", geography = "county", year = 2018, state = "VA",
                      survey = "acs5", geometry = TRUE, cache_table = TRUE) %>% st_transform(crs = 4326)
```

```{r, fig.height = 4}
#get data from 2017 and 2018 separately bc it has a different format
data_2018_and_2017 <-readr::read_csv(here::here("data",
                                                "original", "Substance_Abuse",
                                                "CDC Opioid Prescription Data - 2018 (1).csv"))

#get the relevant data - merged with va borders data - to create maps for each year
create.map <- function(year) {
  link <- paste(paste("http://www.cdc.gov/drugoverdose/maps/rxcounty", year, sep = ""), ".html", sep = "")
  rate_for_year <- html(link)
  tables <- rate_for_year %>% html_table(fill = TRUE)
  table_for_year <- tables[[1]]
  rate_description <- paste(year, "Prescribing Rate")
  table_for_year <- filter(table_for_year, State == 'VA')
  #merge new_tbl with va_borders data
  new_tbl <- merge(va_borders, table_for_year, by.x = "GEOID", by.y = "FIPS County Code")
  column <- new_tbl[ ,8]
  column$geometry = NULL
  #conver the column containing opiod prescription rates to a numeric column instead of character
  column <- as.numeric(sapply(column, noquote))
  new_tbl <- mutate(new_tbl, 'Rate' = column)
}

#special create_maps function for 2017 and 2018
create.map.special <- function(year, table) {
  table_for_year <- filter(table, Year == year)
  new_tbl <- merge(va_borders, table_for_year, by.x = "GEOID", by.y = "State/County FIPS Code")
  new_tbl <- rename(new_tbl, 'Rate' = 'Opiod Prescription Rate per 100')
}

#create corresponding maps for all the years
mapping_2017 <- create.map.special("2017", data_2018_and_2017)
mapping_2018 <- create.map.special("2018", data_2018_and_2017)
mapping_2006 <- create.map("2006")
mapping_2007 <- create.map("2007")
mapping_2008 <- create.map("2008")
mapping_2009 <- create.map("2009")
mapping_2010 <- create.map("2010")
mapping_2011 <- create.map("2011")
mapping_2012 <- create.map("2012")
mapping_2013 <- create.map("2013")
mapping_2014 <- create.map("2014")
mapping_2015 <- create.map("2015")
mapping_2016 <- create.map("2016")

#combine all possible rates from all years together into one dataset
all_rates <- c(mapping_2006$Rate, mapping_2007$Rate, mapping_2008$Rate, mapping_2009$Rate,
               mapping_2010$Rate, mapping_2011$Rate, mapping_2012$Rate, mapping_2013$Rate,
               mapping_2014$Rate, mapping_2015$Rate, mapping_2016$Rate, mapping_2017$Rate,
               mapping_2018$Rate)
all_rates <- na.omit(all_rates)

#use Jenks breaks to see ideal disribution of Opioid Prescription Rates for map scale
generic_bins <-getJenksBreaks(all_rates, k = 6)
generic_bins <- sapply(generic_bins, round)
generic_palette <-colorBin("BuPu", domain = all_rates, bins = c(0, 60, 120, 200, 360, 580))

#label function for each respective year and map
generate.label <- function(year_mapping) {
  my_label <- paste("<strong>", year_mapping$NAME,"<br/></strong>", "Rate: ", year_mapping$Rate, "<br/>",
                    sep="") %>%
    lapply(htmltools::HTML)
}

#create the leaflet
leaflet(width = "100%") %>%
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  #add polygon for each year with respective template, label, and data
  addPolygons(data = mapping_2016, fillColor = ~generic_palette(mapping_2016$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2016',
              label = generate.label(mapping_2016),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2015, fillColor = ~generic_palette(mapping_2015$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2015',
              label = generate.label(mapping_2015),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2014, fillColor = ~generic_palette(mapping_2014$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2014',
              label = generate.label(mapping_2014),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2013, fillColor = ~generic_palette(mapping_2013$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2013',
              label = generate.label(mapping_2013),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2012, fillColor = ~generic_palette(mapping_2012$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2012',
              label = generate.label(mapping_2012),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2011, fillColor = ~generic_palette(mapping_2011$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2011',
              label = generate.label(mapping_2011),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2010, fillColor = ~generic_palette(mapping_2010$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2010',
              label = generate.label(mapping_2010),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2009, fillColor = ~generic_palette(mapping_2009$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2009',
              label = generate.label(mapping_2009),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2008, fillColor = ~generic_palette(mapping_2008$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2008',
              label = generate.label(mapping_2008),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2007, fillColor = ~generic_palette(mapping_2007$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2007',
              label = generate.label(mapping_2007),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2006, fillColor = ~generic_palette(mapping_2006$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2006',
              label = generate.label(mapping_2006),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2017, fillColor = ~generic_palette(mapping_2017$Rate),
              weight = 1, color =  "#444444", fillOpacity = 0.7, group = '2017',
              label = generate.label(mapping_2017),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addPolygons(data = mapping_2018, fillColor = ~generic_palette(mapping_2018$Rate),
              weight = 1, color = "#444444", fillOpacity = 0.7, group = '2018',
              label = generate.label(mapping_2018),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addLegend(pal = generic_palette, values = generic_bins,
            title = paste("Opiod Prescription Rate per 100 People"), position = "bottomright") %>%
  #layer for each year
  addLayersControl(baseGroups = c("2006", "2007", "2008", "2009", "2010",
                                  "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"),
                   options = list(collapsed = FALSE))
```
<br>
The Virginia Department of Health Office of Epidemiology provides further insight into substance abuse into Halifax county. Data from unintentional drug overdose in Halifax illustrates that the majority of overdoses are due to opioids, followed by other drugs and with a small portion being heroin related. 
<br>
```{r}
#read in data source
datasource <- readr::read_csv(here::here("data",
                                         "original", "Substance_Abuse",
                                         "Ed Data VDH - Copy of Halifax.csv"))
# ggplot for the data
ggplot(datasource, aes(x =Year, y =Count, fill=Drug))+
  geom_area(alpha = 0.7) + 
  scale_fill_manual(values = cbbPalette) +
  labs(x = "Year", y = "ED Overdose Visits") +
  ggtitle("Emergency Department Overdose Visits in Halifax, VA") +
  theme(legend.title = element_blank())
```
<br>
Another important aspect of substance abuse, especially as it relates to incarceration and recidivism, is looking at alcohol related abuse and overdose. Data provided by County Health Rankings illustrates that the percentage of adults reporting heavy or binge drinking has increased steadily since 2011. This trend parallels that of Virginia as a whole, which has a consistently higher rate than Halifax. The corresponding map of this data illustrates how the majority of counties in Virginia, Halifax included, become redder over time as rates steadily increase. 
<br>
```{r}
#load the data source from the CSV
datasource <- readr::read_csv(here::here("data", "original", "Substance_Abuse",
                                         "Excessive Drinking and Alcohol-Impaired Driving Deaths - Halifax (1).csv"))

#grab the '% Excessive Drinking' column for Halifax
list <- c(14, 14, 14, 13, 13, 10 ,10, 11, 8, 8)
#grab the '% Excessive Drinking' column for VA in general
va <- c(17, 17, 17, 17, 17, 16, 16, 16, 16, 16)
ggplot(data = datasource, aes(x = X1)) +
  #add geom_lines for each location
  geom_line(aes(y = list, colour = "#CC6666"), lwd = 1.1) +
  geom_line(aes(y = va, colour = "#9999CC"), lwd = 1.1) +
  labs(x = 'Year', y = '% Excessive Drinking', title = "Excessive Drinking Rates") + scale_x_continuous(breaks = seq(2011, 2020, 2), lim = c(2011, 2020)) +
  #add relevant scaling for y axis
  scale_y_continuous(breaks = seq(5, 20, 5), lim = c(5, 20))  +
  #relabel the scale appropriately
  scale_color_manual(labels = c("VA", "Halifax, VA"), values = c(cbbPalette[2], cbbPalette[1])) +
  guides(color=guide_legend("Location")) +
  theme(legend.title = element_blank())
```
<br>
Lastly, it is important to understand substance abuse and its relationship with incarceration through the policy level of the ecological model. Data from the American Civil Liberties Union (ACLU) shows the racial disparities in marijuana arrests between Black and White people (per 100k people). In Virginia, Black people are 3.4x times more likely to be arrested for marijuana possession than white people, a rate that has steadily increased from 2010 to 2018. In some counties, the rates are as high as above 88 times. Halifax contains a more moderate rate of 2.9x; however, these numbers still illustrate racial disparities for substance abuse as it relates to  criminal justice and law enforcement systems. 
<br>
```{r, fig.height = 6}
datasource <- readr::read_csv(here::here("data",
                                         "original", "Substance_Abuse",
                                         "Racial Disparities in Marijuana Arrests by VA County - 2018 (1).csv"))

va_borders <- get_acs(table = "B01003", geography = "county", year = 2018, state = "VA",
                      survey = "acs5", geometry = TRUE, cache_table = TRUE) %>% st_transform(crs = 4326)
datasource <- merge(va_borders, datasource, by.x = "GEOID", by.y = "FIPS Code")
unstable <- filter(datasource, `Meets Population & Reporting Thresholds` == "No")

general_bins <- getJenksBreaks(datasource$`Times more likely Black person arrested in 2018`, k = 6)
general_bins <- sapply(general_bins, round)

general_palette <- colorBin("BuPu", domain = datasource$`Times more likely Black person arrested in 2018`, bins = general_bins)
label <- paste("County: ", datasource$County,"<br/>", "Rate: ",
               paste(datasource$`Times more likely Black person arrested in 2018`, 'x',
                     sep = ""), "<br/>",
               sep="") %>%
  lapply(htmltools::HTML)
```
```{r}
leaflet(width = "100%") %>%
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>%
  addPolygons(data = datasource, 
              fillColor = ~general_palette(datasource$`Times more likely Black person arrested in 2018`),
              weight = 1, color = "#444444", fillOpacity = 0.7,
              label = label,
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "13px", direction = "auto")) %>%
  addLegend(pal = general_palette, values = general_bins,
            title = "Rates of Black vs White arrests <br>for marijuana possession (100k people)", position = "bottomright")
```

### Conclusion and Policy Implications 

[Here you could highlight the main takeaways and the potential policy implications of your findings.] 

### References 

[List your references here using APA format (or at least standardize all of the references using the same format).]
