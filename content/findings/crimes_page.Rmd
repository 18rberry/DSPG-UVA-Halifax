---
title: "Crimes"
description: "What are the trends in crimes in Halifax?"
tags: ["R", "Visualization"]
weight: 3
draft: false
output: html_document
---
 
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 15, fig.height = 10)

options(scipen = 10000)
```

```{r load_libs_data}
library(here)
library(dplyr)
library(readr)
library(lubridate)
library(ggplot2)
library(stringr)
library(tigris)
library(tidycensus)
library(sf)
library(patchwork)
library(leaflet)
library(leaflet.mapboxgl)
library(purrr)
library(glue)

# all VA crimes between 2010 and 2019
all_va_crime <- vroom::vroom(here("data", "original", "Crime", "full_va_crime", "clean_all_arrest_all_years.csv"))

# VA county population by race from census
va_pop_by_race <- read_csv(here("data", "original", "Crime", "full_va_crime", "clean_county_pop_by_race.csv"))

# all Halifax county crimes between 2010 and 2019
halifax_crime <- all_va_crime %>% 
  filter(county_cap == "HALIFAX")


theme_set(theme_minimal() +
            theme(plot.title = element_text(hjust = 0.5, color = "gray10", size = 24),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", face = "italic", size = 20),
                  axis.title = element_text(size = 20, color = "gray10"),
                  axis.text = element_text(size = 18, color = "gray30"),
                  strip.text = element_text(size = 22, color = "gray30"),
                  panel.spacing = unit(4, "lines"),
                  legend.key.size = unit(3, "line"),
                  legend.text = element_text(size = 16, color = "gray30"),
                  legend.title = element_text(size = 22, color = "gray10")))

cbbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

options(mapbox.accessToken = Sys.getenv("MAPBOX_TOKEN"))
```

### Halifax county crime trends

#### Overall crime trends over time

```{r halifax_crimes}
halifax_crime %>%
  group_by(incident_year) %>%
  tally %>%
  ggplot(aes(x = incident_year, y = n)) + 
  geom_bar(stat = 'identity', fill = "#56B4E9") + 
  scale_x_continuous(breaks = c(seq(2010, 2019)),
                     labels = c(seq(2010, 2019))) +
  labs(y = "Number of Crimes",
       x = NULL,
       title = "Total Number of Crimes from 2010 to 2019")
```

#### Most common offense types and clearance rates

```{r halifax_top_crimes}

halifax_crime_tally <- halifax_crime %>%
  group_by(offense_type) %>%
  tally 

per_clear_data <- halifax_crime %>%
  mutate(clearance_stat = case_when(incident_clearance == "Cleared by Arrest" ~ 1,
                                    incident_clearance != "Cleared by Arrest" ~ 0)
         ) %>%
  group_by(offense_type, clearance_stat) %>%
  summarise(perc_clear = n()) %>%
  group_by(offense_type) %>%
  mutate(perc_clear = perc_clear/sum(perc_clear) * 100) %>%
  filter(clearance_stat == 1) %>% 
  inner_join(halifax_crime_tally, by = "offense_type")




total_crime_plot <- halifax_crime_tally %>%
  inner_join(per_clear_data, by = c("offense_type", "n")) %>% 
  ggplot(aes(x = reorder(offense_type, n), y = n)) +
  geom_bar(stat = 'identity', fill = "#56B4E9") +
  coord_flip() + 
  labs(x = NULL,
       y = "Number of Crimes")



per_clear_plot <- halifax_crime %>%
  mutate(clearance_stat = case_when(incident_clearance == "Cleared by Arrest" ~ 1,
                                    incident_clearance != "Cleared by Arrest" ~ 0)
         ) %>%
  group_by(offense_type, clearance_stat) %>%
  summarise(perc_clear = n()) %>%
  group_by(offense_type) %>%
  mutate(perc_clear = perc_clear/sum(perc_clear) * 100) %>%
  filter(clearance_stat == 1) %>%
  inner_join(halifax_crime_tally, by = "offense_type") %>%
  ggplot(aes(x = reorder(offense_type, n), y = perc_clear)) +
  geom_bar(stat = 'identity', fill = "#56B4E9") +
  coord_flip() + 
  labs(x = NULL,
       y = "Percent of Crimes \nCleared by Arrest") +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  
total_crime_plot + per_clear_plot + 
  plot_annotation(title = 'Number of Crimes and Percent Cleared by Arrest Type')
```

#### Crime trends by race (per 1000 of that race)

```{r halifax_crime_by_race}
va_crime_per_cap <- all_va_crime %>%
  filter(offender_race %in% c("Black or African American",
                              "White")) %>%
  group_by(incident_year, offender_race, county_cap) %>%
  tally %>%
  left_join(va_pop_by_race, by = c("county_cap")) %>% 
  mutate(crime_per_cap = case_when(offender_race == "Black or African American" ~ n / pop_Black,
                                   offender_race == "White" ~ n / pop_White),
         is_halifax = county_cap == "HALIFAX",
         county_and_race = paste0(county_cap, offender_race),
         is_halifax_and_race = paste0(is_halifax, offender_race)

         ) 

ggplot(filter(va_crime_per_cap, county_cap == "HALIFAX"), aes(x = incident_year, 
                                                 y = crime_per_cap * 1000, 
                                                 color = offender_race)) + 
  geom_line(data = filter(va_crime_per_cap, county_cap != "HALIFAX"), 
            aes(group = county_and_race),
            color = "#dddddd") +
  geom_line(lwd = 1.1) +
  geom_point(size = 2) + 
  scale_x_continuous(breaks = c(seq(2010, 2019, by = 2)),
                     labels = c(seq(2010, 2019, by = 2))) +
  scale_color_manual(values = cbbPalette,
                     labels = c("Black", "White")) + 
  labs(x = NULL,
       y = "Number of Crimes per Per 1000 People",
       title = "Total Number of Crimes by Race per 1000 People",
       color = NULL) +
  coord_cartesian(ylim = c(0, 200)) +
  facet_grid(.~offender_race) +
  theme(legend.position = "none")



```

#### Clearance rates by race

```{r}
clearance_data <- all_va_crime %>%
  filter(offender_race %in% c("Black or African American",
                              "White")) %>%
  mutate(clearance_stat = case_when(incident_clearance == "Cleared by Arrest" ~ 1,
                                    incident_clearance != "Cleared by Arrest" ~ 0)
         ) %>%
  group_by(incident_year, offender_race, county_cap, clearance_stat) %>%
  summarise(perc_clear = n()) %>%
  group_by(incident_year, county_cap) %>%
  mutate(perc_clear = perc_clear/sum(perc_clear) * 100) %>%
  filter(clearance_stat == 1) %>%
  mutate(county_and_race = paste0(county_cap, offender_race))


ggplot(filter(clearance_data, county_cap == "HALIFAX"), 
         aes(x = incident_year, y = perc_clear, color = offender_race)) + 
  geom_line(data = filter(clearance_data, county_cap != "HALIFAX"), 
            aes(group = county_and_race),
            color = "#dddddd") +
  geom_line(lwd = 1.1) +
  geom_point(size = 2) + 
  scale_x_continuous(breaks = c(seq(2010, 2019, by = 2)),
                     labels = c(seq(2010, 2019, by = 2))) +
  scale_color_manual(values = cbbPalette,
                     labels = c("Black", "White")) + 
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  labs(x = NULL,
       y = "Percent of Crimes Cleared by Arrest",
       title = "Percent of Crimes Cleared by Arrest by Race",
       color = "Offender\nRace") +
  coord_cartesian(ylim = c(0, 100)) +
  facet_grid(.~offender_race) +
  theme(legend.position = "none")
  
```


### Comparison of Halifax county to other VA counties

#### All Crimes Map

```{r all_crime_map}
counties_sp <- read_sf(here("data", "working", "va_counties.geojson"),
                       quiet = TRUE) %>% 
  st_transform(crs = 4326) %>% 
  mutate(county_cap = toupper(str_extract(NAME, r"(.*(?= County| city))")))
                                


# I need to make: black crime per capita black, white crime per capita white, total crime per capita total, as well as drug crimes per capita across all three of these
mapping_data <- all_va_crime %>% 
  group_by(county_cap) %>% 
  summarize(total_crime = n(), 
            total_crime_white = sum(offender_race == "White"),
            total_crime_black = sum(offender_race == "Black or African American"),
            total_drug_crime = sum(offense_type == "Drug/Narcotic Violations"),
            total_drug_crime_white = sum(offense_type == "Drug/Narcotic Violations" & offender_race == "White"),
            total_drug_crime_black = sum(offense_type == "Drug/Narcotic Violations" & offender_race == "Black or African American")) %>%
  inner_join(va_pop_by_race, by = "county_cap") %>% 
  mutate(year_crime_per_1000 = total_crime / total_pop / 10 * 1000, # make yearly by dividing by years, there are 10
         year_crime_white_per_1000 = total_crime_white / pop_White / 10 * 1000,
         year_crime_black_per_1000 = total_crime_black / pop_Black / 10 * 1000,
         year_drug_crime_per_1000 = total_drug_crime / total_pop / 10 * 1000,
         year_drug_crime_white_per_1000 = total_drug_crime_white / pop_White / 10 * 1000,
         year_drug_crime_black_per_1000 = total_drug_crime_black / pop_Black / 10 * 1000) %>% 
  left_join(counties_sp, ., by = "county_cap") %>% 
  group_by(county_cap) %>% 
  slice_head(1) %>% 
  ungroup()

leaflet_scale <- colorBin("BuPu" , c(0, 200), c(0, 30, 40, 50, 100, 400))

mapping_data %>% 
  leaflet(width = "100%") %>% 
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>% 
  addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_crime_per_1000),
              group = "Yearly Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_crime_per_1000, 1)}"), htmltools::HTML)) %>% 
    addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_crime_white_per_1000),
              group = "Yearly White Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_crime_white_per_1000, 1)}"), htmltools::HTML)) %>% 
  addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_crime_black_per_1000),
              group = "Yearly Black Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_crime_black_per_1000, 1)}"), htmltools::HTML)) %>% 
  addLayersControl(
    baseGroups = c("Yearly Crimes Per 1000", 
                   "Yearly White Crimes Per 1000",
                   "Yearly Black Crimes Per 1000"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend("bottomright", pal = leaflet_scale, values = ~year_crime_per_1000,
            title = "Yearly Crimes Per 1000 People",
            opacity = .8)

```


#### Drug Crimes Map

```{r drug_crime_map}
leaflet_scale <- colorBin("BuPu" , c(0, 120), c(0, 5, 10, 30, 120))

mapping_data %>% 
  leaflet(width = "100%") %>% 
  addMapboxGL(style = "mapbox://styles/mapbox/light-v9") %>% 
  addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_drug_crime_per_1000),
              group = "Yearly Drug Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_drug_crime_per_1000, 1)}"), htmltools::HTML)) %>% 
    addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_drug_crime_white_per_1000),
              group = "Yearly White Drug Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_drug_crime_white_per_1000, 1)}"), htmltools::HTML)) %>% 
  addPolygons(color = "#444444", weight = 0.5, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              fillColor = ~leaflet_scale(year_drug_crime_black_per_1000),
              group = "Yearly Black Drug Crimes Per 1000",
              label = ~map(glue("{NAME.x} County<br/>
                                 Yearly Rate Per 1000: {round(year_drug_crime_black_per_1000, 1)}"), htmltools::HTML)) %>% 
  addLayersControl(
    baseGroups = c("Yearly Drug Crimes Per 1000", 
                   "Yearly White Drug Crimes Per 1000",
                   "Yearly Black Drug Crimes Per 1000"),
    options = layersControlOptions(collapsed = FALSE)) %>% 
  addLegend("bottomright", pal = leaflet_scale, values = ~year_crime_per_1000,
            title = "Yearly Drug Crimes Per 1000 People",
            opacity = .8)

```
